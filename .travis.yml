#
#	MetaCall Guix by Parra Studios
#	Docker image for using GuixSD in a CI/CD environment.
#
#	Copyright (C) 2016 - 2019 Vicente Eduardo Ferrer Garcia <vic798@gmail.com>
#
#	Licensed under the Apache License, Version 2.0 (the "License");
#	you may not use this file except in compliance with the License.
#	You may obtain a copy of the License at
#
#		http://www.apache.org/licenses/LICENSE-2.0
#
#	Unless required by applicable law or agreed to in writing, software
#	distributed under the License is distributed on an "AS IS" BASIS,
#	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#	See the License for the specific language governing permissions and
#	limitations under the License.
#

language: minimal

branches:
  only:
  - master

sudo: required

services:
  - docker

dist: bionic

# Global environment variables
env:
  global:
    - DOCKER_VERSION: 19.03.2
    - DOCKER_BUILDKIT: 1

# Update Docker
before_script:
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo apt-key fingerprint 0EBFCD88
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable edge"
  - sudo apt-get update
  - apt-cache policy docker-ce
  - sudo apt-get install -y docker-ce=${DOCKER_VERSION}~3-0~ubuntu-$(lsb_release -cs)
  - docker version
  - sudo sh -c 'echo "{ \"features\": { \"buildkit\": true } }" > /etc/docker/daemon.json'
  - sudo cat /etc/docker/daemon.json
  - sudo systemctl restart docker
  - sudo systemctl status docker
#  - git clone git://github.com/docker/buildx && cd buildx && sudo make install

# Run the build and packaging
script:
  - docker buildx build --build-arg METACALL_GUIX_VERSION="1.0.1" METACALL_GUIX_ARCH="x86_64" .

# Upload to Docker the built images
after_script:

